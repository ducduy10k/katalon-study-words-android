pipeline {
    agent any
    options {
        timestamps()          // Hi·ªÉn th·ªã th·ªùi gian trong log
        ansiColor('xterm')     // M√†u s·∫Øc log
    }
    stages {
        stage('Checkout') {
            steps {
                echo 'Checkout source code from GitHub...'
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[url: 'https://github.com/ducduy10k/katalon-study-words-android.git']]
                ])
            }
        }

        stage('Run Katalon Tests (Docker)') {
            steps {
                echo "Running Katalon Test Suite using Docker container..."
                sh """
                     "/Users/nguyenduy/Downloads/Katalon_Studio_Engine_MacOS-10.4.0/Katalon Studio Engine.app/Contents/MacOS/katalonc" \
                     -noSplash \
                     -runMode=console \
                     -projectPath="/Users/nguyenduy/.jenkins/workspace/katalon_study_words_mpl_main/Android Mobile Tests with Katalon Studio.prj" \
                     -retry=0 -testSuitePath="Test Suites/Open App" -browserType="Android" -deviceId="2bc37605" -executionProfile="default" \
                      --config -proxy.auth.option=NO_PROXY -proxy.system.option=NO_PROXY -proxy.system.applyToDesiredCapabilities=true -webui.autoUpdateDrivers=true \
                     -appiumDirectory="/Users/nguyenduy/.nvm/versions/node/v24.11.0/lib/node_modules/appium"
                    """
            }
        }
    }

    stage('Publish JUnit to Dashboard') {
        steps {
            echo "Publishing JUnit report..."
            junit allowEmptyResults: true, testResults: "Reports/**/*.xml"
        }
    }

    stage('Publish HTML Report') {
            steps {
                echo "Publishing HTML report..."
                publishHTML(target: [
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: "Reports",
                    reportFiles: "report.html",
                    reportName: "Katalon HTML Report"
                ])
            }
        }

        stage('Archive All Reports') {
            steps {
                echo "Archiving reports, logs, screenshots..."
                archiveArtifacts artifacts: "Reports/**/*", fingerprint: true
            }
        }
    }

    post {
        always {
            echo "===== FINAL SUMMARY ====="
            echo "Build finished. Reports archived at: ${env.WORKSPACE}/Reports"
        }
        success {
            echo "BUILD PASSED üéâ"
        }
        failure {
            echo "BUILD FAILED ‚ùå ‚Äî Check JUnit & HTML reports."
        }
    }
}
